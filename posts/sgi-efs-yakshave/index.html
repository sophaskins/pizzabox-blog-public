<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.73.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>A yak shave with SGI&#39;s EFS &middot; Pizza Box Computer</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://blog.pizzabox.computer/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://blog.pizzabox.computer/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://blog.pizzabox.computer/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://blog.pizzabox.computer/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://blog.pizzabox.computer/"><h1>Pizza Box Computer</h1></a>
      <p class="lead">
       <a href="https://blog.sophaskins.net/">A Sophie Haskins Project</a> 
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/alphastation/">AlphaStation 200</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/aviion300/">AViiON AV/300D</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/alphaaxp/">DEC 3000 300X</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/decstation/">DECstation 5000/200</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/hp425e/">HP 9000 Model 425e</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/hp712/">HP 9000 Model 712</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/multia/">Multia</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/nextstation/">NeXTstation</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/powermac6100/">PowerMac 6100</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/quadra605/">Quadra 605</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/quadra610/">Quadra 610</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/powerstation250/">RS/6000 Model 250</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/indy/">SGI Indy</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/sparcstation/">SPARCstation 1&#43;</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/sparcstation20/">SPARCstation 20</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/sunblade150/">SunBlade 150</a></li>
          <li><a href="https://blog.pizzabox.computer/pizzaboxes/vaxstation/">VAXstation 4000 VLC</a></li></ul>
    </nav>

    <ul class="sidebar-nav">
      <li><a href="/posts">Post Index</a></li>
    </ul>
  </div>
</aside>

    <main class="content container">
    <div class="post">
  <h1>A yak shave with SGI&#39;s EFS</h1>
  <time datetime=2018-07-04T15:00:00-0400 class="post-date">Wed, Jul 4, 2018</time>
  <p>Over the past few weekends I&rsquo;ve gone on a bit of an adventure with the SGI Indy. <strong>This yak-shave has everything</strong> - an OS install, lots of SCSI problems, a <em>completely overkill</em> golang utility, and a happy ending. Since it&rsquo;s pretty long, I&rsquo;m gonna dive right in.</p>
<h2 id="a-disk-upgrade">A disk upgrade</h2>
<p>It all started with a drive replacement - I got an order of SCS2SDs in and decided that I should <strong>allocate the faster SCSI2SDv6 I&rsquo;d been saving to the Indy</strong>. At 100 MHz it&rsquo;s one of the fastest pizzaboxes in my collection, so I think it&rsquo;ll be better able to use the increased IO bandwidth the v6 can provide - <a href="http://www.codesrc.com/mediawiki/index.php/SCSI2SD#Technical_Specifications">supposedly</a> up to 10MB/s vs 2.6 MB/s for the v5.</p>

<link rel="stylesheet" href="/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="/img/indy/scsi2sd.jpg" />
    </div>
    <a href="/img/indy/scsi2sd.jpg" itemprop="contentUrl"></a>
  </figure>
</div>

<p>Installing the new drive took a few steps. First, the firmware my v6 had loaded on it seemed to have some odd bugs - <strong>the Indy wouldn&rsquo;t POST with it connected</strong>! I tried a lot of variations of settings and what ended up working was&hellip;updating the firmware of the drive.</p>
<p>Out of the box, the SCSI2SD acts as a hard drive on SCSI ID 0 - a reasonable configuration for most systems. Unfortunately, SGI <a href="http://ibgwww.colorado.edu/~lessem/psyc5112/usail/peripherals/remove/sgi.html">assigns</a> ID 0 to the <em>controller</em> (<a href="https://en.wikipedia.org/wiki/SCSI#Parallel_interface_2">most systems</a> assign the controller ID 7). When the SCSI2SD is set to 0, the Indy believes that <em>all</em> SCSI IDs are pointing to the SCSI2SD, and basically nothing works. When I set it to ID 1, I was able to <a href="https://software.majix.org/irix/install-fx.shtml">format it with fx</a> and move on to the install.</p>
<h2 id="scsi-gremlins-ruin-an-evening">SCSI gremlins ruin an evening</h2>
<p>A disk replacement is a natural opportunity to install a fresh OS. The previous OS had been loaded via <a href="/posts/getting-an-indy-desktop/#netbooting-a-new-tool">netboot</a> and controlled via a serial console - I had neither a CD-ROM drive nor a suitable keyboard and mouse at the time, so this would be my first graphical install. I also took this opportunity to <strong>downgrade from IRIX 6.5 to 5.3</strong> - while 6.5 ran OK, my Indy only has 64 MB of RAM and I&rsquo;ve seen recommendations to use older versions of IRIX for best performance on lower-spec Indys.</p>
<p>With IRIX 5.3 burned to a CD, the hard drive formatted, and (so I thought) all the SCSI problems behind me, I booted in to the installer and watched expectantly.</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">if yr having scsi problems I feel bad for u son<br>use active termination and target drives by LUN</p>&mdash; cron mom (@sophaskins) <a href="https://twitter.com/sophaskins/status/1007411791306117121?ref_src=twsrc%5Etfw">June 14, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>After I&rsquo;d start the install, I kept hitting a bus timeout, and it seemed to never recover. I tried swapping terminators, turning on and off termination on the internal drive, setting the &ldquo;parity&rdquo; jumper on the CD-ROM, reseating all the cabling, and <strong>nothing could keep it stable enough to complete a full install</strong>.</p>
<blockquote class="twitter-tweet"><p lang="und" dir="ltr">Whyyyyyyyyy <a href="https://t.co/Un66ORSCHf">pic.twitter.com/Un66ORSCHf</a></p>&mdash; cron mom (@sophaskins) <a href="https://twitter.com/sophaskins/status/1007423991777234945?ref_src=twsrc%5Etfw">June 15, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>Eventually I gave up and went with plan b: <strong>the SCSI2SD can emulate multiple drives</strong>. It&rsquo;s a little bit annoying to set up - you can easily set the second, etc, drive to be a CD-ROM but loading the ISO on to it requires <code>dd</code>-ing the ISO to the appropriate offset after your primary disk.</p>
<pre><code>&gt; dd if=C:\Users\haski\Downloads\IRIX_5.3.iso seek=16567501 of=&quot;\\.\Volume{a03b15f0-0f8b-11e8-9c75-00155d4b013b}&quot; --progress
</code></pre><p>I try to avoid using this feature because &ldquo;<code>dd</code>-ing over your hard disk&rdquo; sounds like an even worse way to spend an evening than &ldquo;using a single-speed CD-ROM drive&rdquo;, but if you&rsquo;re careful, it works:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Ok that also didn’t work but setting it up as another drive on the *same* SCSI2SD worked great and now it’s working and I can go to bed happy <a href="https://t.co/OnTaXLUGCl">pic.twitter.com/OnTaXLUGCl</a></p>&mdash; cron mom (@sophaskins) <a href="https://twitter.com/sophaskins/status/1007462825529348096?ref_src=twsrc%5Etfw">June 15, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="motivating-a-yak-shave">Motivating a yak shave</h2>
<p>With SCSI problems behind me, the OS install finished smoothly and my Indy was running IRIX 5.3 like a champ. The base OS is pretty spartan - it includes a basic compiler but almost no tools for development. Thankfully, I had another &ldquo;ISO&rdquo; (just a raw dump from a CD, but not in ISO9660 format - it&rsquo;s in &ldquo;EFS&rdquo; format) labeled &ldquo;IRIS Development Option 5.3&rdquo; - sounds like just what I need! I had a <strong>few options to load the software</strong>:</p>
<ul>
<li><strong>burn it to a CD</strong> and hope that the Indy and my SCSI CD-ROM can be friends long enough to install some software (unlikely)</li>
<li>load the image in to the <strong>SCSI2SD&rsquo;s fake CD drive</strong> (tedious and requires opening the Indy&rsquo;s case back up - ugh)</li>
<li>put the ISO file on my NAS and have the Indy <strong>mount it as a <a href="https://en.wikipedia.org/wiki/Loop_device">loopback device</a></strong> (unfortunately, not possible on IRIX)</li>
<li>get <strong>another computer running that can read the image</strong> and copy the files to my NAS where the Indy can just read them directly
<ul>
<li>while the <strong>Linux kernel does have <a href="https://github.com/torvalds/linux/tree/master/fs/efs">efs support</a></strong>, it&rsquo;s neither compiled in to the Ubuntu base nor can I find a package that includes the module. Its 2018 and apparently I refuse to compile my own kernel modules anymore.</li>
<li><strong>the BSDs <a href="http://cvsweb.netbsd.org/bsdweb.cgi/src/sys/fs/efs/?only_with_tag=MAIN">have support</a></strong> but I didn&rsquo;t want to go through the hassle of setting up a VM or whatever and shuffling all the files around.</li>
</ul>
</li>
</ul>
<p>This left one final option: <strong>write a program to convert the image in to something more portable</strong> (like a tarball) that I could unpack on my NAS and make available to the Indy. <strong>Is this <em>reasonable</em>? Absolutely not.</strong> But it sounded like a hell of a fun project!</p>
<h2 id="following-along">Following along</h2>
<p>The code I&rsquo;m referencing in this section lives at <a href="https://github.com/sophaskins/efs2tar">https://github.com/sophaskins/efs2tar</a> - please take a look at how it all fits together! I&rsquo;m running it against an image of &ldquo;IRIS Development Option 5.3&rdquo;, but I suspect it&rsquo;ll work similarly for other images too - the <a href="https://archive.org/search.php?query=sgi&amp;and%5B%5D=mediatype%3A%22software%22&amp;page=2">Internet Archive</a> has many available.</p>
<p>I use my golang struct definitions to illustrate what the on-disk format looks like - other implementations may name the struct members, etc, differently. Also note that <strong>EFS is big-endian</strong>, so the implementation needs to reference that at all the places where we <em>parse</em> bytes.</p>
<h2 id="filesystem-headers">Filesystem headers</h2>
<p>My goal was simple: <strong>efs disk image in, tarball out</strong>. I made a blank golang project, opened up the NetBSD source for a guide, and started reading raw bytes.</p>
<p>Since the sources <a href="https://github.com/NetBSD/src/blob/4b6bcd63f3d324191969bdbe86c815937969e874/sys/fs/efs/efs.h#L119">helpfully point out</a> that the superblock lives in the first (zero-indexed) 512-byte block, I wrote up some code to unpack those bytes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// cmd/where-is-the-superblock/main.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;os&#34;</span>

	<span style="color:#e6db74">&#34;github.com/davecgh/go-spew/spew&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">file</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Open</span>(<span style="color:#e6db74">&#34;./input.iso&#34;</span>)
	<span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">1024</span>)
	<span style="color:#a6e22e">file</span>.<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">b</span>)
	<span style="color:#a6e22e">spew</span>.<span style="color:#a6e22e">Dump</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">512</span>:<span style="color:#ae81ff">1024</span>])
}</code></pre></div>
<p>and got&hellip;nothing but zeros</p>
<pre><code>&gt; go run .\cmd\where-is-the-superblock\main.go
([]uint8) (len=512 cap=512) {
 00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000060  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000070  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000080  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000090  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000000f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000100  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000110  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000120  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000130  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000140  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000150  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000160  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000170  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000180  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 00000190  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001a0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001d0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001e0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
}
</code></pre><p>What the heck? The NetBSD sources also claim that block 0 is unused, but if we look at <em>those</em>, there&rsquo;s definitely some non-zero bytes. The first 8 bytes are:</p>
<pre><code>0b e5 a9 41 00 00 00 00
</code></pre><p>Filesystems (like many formats) often use <a href="https://en.wikipedia.org/wiki/Magic_number_(programming)">&ldquo;magic numbers&rdquo;</a> - an arbitrary bunch of bytes that occur at a known location so they can be quickly identified by type. Maybe this string is a magic number? I grepped for <code>be5a941</code> in the NetBSD codebase and got a hit in <a href="https://github.com/NetBSD/src/blob/0bff031265b50be8e8b7719aed82212928d6c1df/sys/sys/bootblock.h#L1292"><code>sys/sys/bootblock.h</code></a> - <strong>it is indeed a magic number</strong>, <code>SGI_BOOT_BLOCK_MAGIC</code>. That <a href="https://github.com/NetBSD/src/blob/0bff031265b50be8e8b7719aed82212928d6c1df/sys/sys/bootblock.h#L1280-L1367">section</a> of the file defines the layout of the <em>boot block</em> of SGI partitions. A deeper dive in to that code and the <a href="http://nixdoc.net/man-pages/IRIX/man7/vh.7.html">IRIX manpage</a> for <code>vh</code> (volume header) explain what&rsquo;s going on.</p>
<p>It turns out, these &ldquo;ISO&rdquo; files aren&rsquo;t just raw EFS filesystems, they&rsquo;re SGI-formatted <em>volumes</em> with an EFS <em>partition</em> on them. There&rsquo;s a whole volume header that has the partition table and some additional info:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// from sgi/vh.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">VolumeHeader</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">MagicNumber</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">Root</span>             <span style="color:#66d9ef">int16</span>
	<span style="color:#a6e22e">Swap</span>             <span style="color:#66d9ef">int16</span>
	<span style="color:#a6e22e">Bootfile</span>         [<span style="color:#ae81ff">16</span>]<span style="color:#66d9ef">byte</span>
	<span style="color:#a6e22e">BootDeviceParams</span> <span style="color:#a6e22e">DeviceParameters</span>
	<span style="color:#a6e22e">VolumeDirectory</span>  [<span style="color:#ae81ff">15</span>]<span style="color:#a6e22e">FileHeader</span>
	<span style="color:#a6e22e">Partitions</span>       [<span style="color:#ae81ff">16</span>]<span style="color:#a6e22e">Partition</span>
	<span style="color:#a6e22e">Checksum</span>         <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">Padding</span>          <span style="color:#66d9ef">int32</span>
}</code></pre></div>
<p>The <code>VolumeDirectory</code> field is pretty neat - its an array of pointers to <strong>files that exist outside of any filesystem</strong>, directly in the volume header. Its apparently usually used for the bootloader and the SGI partitioning program, <code>fx</code> (this is apparently why partitioning happens outside of the OS install process).</p>
<p>The <code>Partitions</code> field contains what block offset each partition starts at, how long it is, and its filesystem type. It was a surprise to me that the partitions can (and do!) overlap! Apparently it&rsquo;s typical for one of the partitions to represent the whole disk, another this header section, and another for the actual partition (the partitioning SunOS uses also has overlaps like this). The EFS partition for my image was number 7.</p>
<h2 id="crawling-inodes">Crawling inodes</h2>
<p>Starting at the offset of the partition, I found the expected data in the Superblock (including the correct <em>filesystem</em> magic number, a plausible filesystem size, etc):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// from efs/filesystem.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SuperBlock</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Size</span>         <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// filesystem size (in BasicBlocks)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FirstCG</span>      <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// BasicBlock offset of the first CG 
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CGSize</span>       <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// CylinderGroup size (in BasicBlocks)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CGInodeSize</span>  <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// Number of BBs per CG that are Inodes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Sectors</span>      <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// sectors per track
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Heads</span>        <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// heads per cylinder
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CGCount</span>      <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// CylinderGroups in the filesystem
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Dirty</span>        <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// whether an fsck is required
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>            <span style="color:#66d9ef">int16</span>    <span style="color:#75715e">// padding
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">CTime</span>        <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// last SuperBlock updated time
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Magic</span>        <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// filesystem magic number
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FSName</span>       [<span style="color:#ae81ff">6</span>]<span style="color:#66d9ef">byte</span>  <span style="color:#75715e">// name of the filesystem
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FSPack</span>       [<span style="color:#ae81ff">6</span>]<span style="color:#66d9ef">byte</span>  <span style="color:#75715e">// fs &#34;pack&#34; name
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">BMSize</span>       <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// size in bytes of bitmap
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FreeBlocks</span>   <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// count of free blocks
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">FreeInodes</span>   <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// count of free inodes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">BMBlock</span>      <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// offset of the bitmap
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ReplicatedSB</span> <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// offset of the replicated superblock
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">LastInode</span>    <span style="color:#66d9ef">int32</span>    <span style="color:#75715e">// last unallocated inode
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">_</span>            [<span style="color:#ae81ff">20</span>]<span style="color:#66d9ef">int8</span> <span style="color:#75715e">// padding
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Checksum</span>     <span style="color:#66d9ef">int32</span>
}</code></pre></div>
<p>Most of this data is irrelevant to my purposes - since I&rsquo;m not adding <em>new</em> data, I don&rsquo;t really care about the bitmap, where the next free inode is, etc. The offset of the first CylinderGroup <em>is</em> important, though. The <strong>filesystem is divided in to &ldquo;cylinder groups&rdquo;</strong> - contiguous groups of blocks where the first <code>CGInodeSize</code> blocks of the cylinder group contain inodes, and the rest is data. The <a href="https://github.com/NetBSD/src/blob/4b6bcd63f3d324191969bdbe86c815937969e874/sys/fs/efs/efs_dinode.h#L28-L31">NetBSD sources</a> note that the root inode is at <em>inode</em> index 2, so probably at index 2 in the inode portion of the first cylinder group.</p>
<p>Each inode includes a bunch of data about the object it represents:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// from efs/inode.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Inode</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Mode</span>       <span style="color:#66d9ef">uint16</span>
	<span style="color:#a6e22e">NumLinks</span>   <span style="color:#66d9ef">int16</span>
	<span style="color:#a6e22e">UID</span>        <span style="color:#66d9ef">uint16</span>
	<span style="color:#a6e22e">GID</span>        <span style="color:#66d9ef">uint16</span>
	<span style="color:#a6e22e">Size</span>       <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">ATime</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">MTime</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">CTime</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">Generation</span> <span style="color:#66d9ef">int32</span>
	<span style="color:#a6e22e">NumExtents</span> <span style="color:#66d9ef">int16</span>
	<span style="color:#a6e22e">Version</span>    <span style="color:#66d9ef">uint8</span>
	<span style="color:#a6e22e">Spare</span>      <span style="color:#66d9ef">uint8</span>
	<span style="color:#75715e">// Payload is a union struct - sometimes it contains extents, but
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// it also can contain other stuff (like link targets and device
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// descriptors, which are not implemented here)
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Payload</span> [<span style="color:#ae81ff">96</span>]<span style="color:#66d9ef">byte</span>
}</code></pre></div>
<p>If we write up a quick program to dump this data, it looks something like:</p>
<pre><code>&gt; go run .\cmd\rootinode\main.go
(efs.Inode) {
 Mode: (uint16) 16895,
 NumLinks: (int16) 5,
 UID: (uint16) 0,
 GID: (uint16) 0,
 Size: (int32) 512,
 ATime: (uint32) 784844972,
 MTime: (uint32) 784844972,
 CTime: (uint32) 784844972,
 Generation: (int32) 784844868,
 NumExtents: (int16) 1,
 Version: (uint8) 0,
 Spare: (uint8) 0,
 Payload: ([96]uint8) (len=96 cap=96) {
  00000000  00 00 00 e0 01 00 00 00  00 00 00 00 00 00 00 00
  00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
  00000020  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
  00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
  00000040  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
  00000050  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 }
}
</code></pre><p>This is really promising - those timestamps (<code>784844972</code>) are in 1994 (<code>1994-11-14T20:29:32+00:00</code>) which seems appropriate given that the disk image I&rsquo;m working on is &ldquo;the developer tools that came with IRIX 5.3&rdquo;. The <code>Mode</code> field indicates that this inode represents a directory - seems reasonable, given that I&rsquo;d expect the root inode to be <code>/</code>.</p>
<p>To find out what&rsquo;s in the directory listing, we need to unpack the <code>Payload</code> field. In this context, it contains <strong>extents - an array of the block ranges that make up the body</strong>. This approach to allocating blocks to files gave the filesystem its name, EFS (the Extent File System). Reading extents is somewhat more complicated than just parsing that Payload field, but we&rsquo;ll get to that later. The extents stored in the root inode look like:</p>
<pre><code>&gt; go run .\cmd\root-inode-extents\main.go
([]efs.Extent) (len=1 cap=1) {
 (efs.Extent) {
  Magic: (uint8) 0,               // side note, yes - the magic number
  StartBlock: (uint32) 224,       // for extents is...zero. Not
  Length: (uint8) 1,              // exactly unique, heh.
  NumIndirectExtents: (uint32) 0
 }
}
</code></pre><p>which seems plausible for the root directory listing - it&rsquo;s short (only one block long), and early in the disk (block 224). Fetching that block is pretty easy, and if you dump it it <em>does</em> appear to have some filenames on it, but reading its format correctly takes a little care. The format of a data block belonging to a directory listing is:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// from efs/directory.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Directory</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Magic</span>     <span style="color:#66d9ef">uint16</span>
	<span style="color:#a6e22e">FirstUsed</span> <span style="color:#66d9ef">uint8</span>
	<span style="color:#a6e22e">Slots</span>     <span style="color:#66d9ef">uint8</span>
	<span style="color:#a6e22e">Data</span>      [<span style="color:#ae81ff">508</span>]<span style="color:#66d9ef">byte</span>
}</code></pre></div>
<p>At the &ldquo;bottom&rdquo; of <code>Data</code> (the low indexes) there are some pointers (<code>Slots</code> many of them) to directory entry offsets (offsets from the base of the struct). The entries live at the &ldquo;top&rdquo; of <code>Data</code> (the high indexes) and are of variable lenth (because they include filename strings!), so are made up of:</p>
<ul>
<li>the index of inode for the entry</li>
<li>how many bytes its name is</li>
<li>the name</li>
</ul>
<p>It&rsquo;s a somewhat wacky scheme - why isn&rsquo;t it just a list of entries starting at <code>Data[0]</code>? This indirect approach allows adding and removing entries without having to rewrite the entire block, which&hellip;I guess is nice if you&rsquo;re dealing with late 1980s / early 1990s disk performance (SGI replaced EFS with XFS for hard disks around 1993, but kept using EFS for CD-ROMs). At any rate, if we follow it, we can read the entries at the root inode, which look pretty rad to me:</p>
<pre><code>&gt; go run .\cmd\root-inode-entries.go
([]efs.DirectoryEntry) (len=8 cap=8) {
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 2,
  Name: (string) (len=1) &quot;.&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 2,
  Name: (string) (len=2) &quot;..&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 3,
  Name: (string) (len=11) &quot;CDgrelnotes&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 4,
  Name: (string) (len=10) &quot;CDrelnotes&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 5,
  Name: (string) (len=4) &quot;dist&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 90,
  Name: (string) (len=7) &quot;insight&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 1525,
  Name: (string) (len=8) &quot;relnotes&quot;
 },
 (efs.DirectoryEntry) {
  InodeIndex: (uint32) 1614,
  Name: (string) (len=12) &quot;RELEASE.info&quot;
 }
}
</code></pre><p>This seems <em>extremely</em> plausible to me as the root of the CD-ROM. The <code>.</code> and <code>..</code> entries even point (correctly) to the same inode (number 2) as the one we&rsquo;re displaying! The system works! From here, it wasn&rsquo;t too implausible to walk the whole filesystem and output filenames. Since it&rsquo;s a tree, we start at the root inode, visit each entry, and if it&rsquo;s a <em>directory</em>, recursively walk starting there. <strong>We have a complete list of all files</strong></p>
<h2 id="file-contents">File contents</h2>
<p>For the inode of a &ldquo;regular&rdquo; file, the extents just point to where the body of the file is. You can literally concatenate the bytes from the extent blocks and get the file, at least for <em>unfragmented</em> files.</p>
<p>An inode&rsquo;s <code>Payload</code> field can fit up to 12 extents - each extent is 8 bytes, and the <code>Payload</code> field is 96 bytes. If a file is made up of <em>more</em> than 12 discontinuous ranges of blocks, its extent descriptors wont fit inside the inode. In this case, EFS switches from &ldquo;direct&rdquo; extents (the inode data contains the extents) to &ldquo;indirect&rdquo; extents (the extents in the inode point to blocks that contain <em>nothing but extents</em>, which are the actual extents of the file). This took me a few tries to implement correctly, but ends up being a fairly simple algorithm:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-golang" data-lang="golang"><span style="color:#75715e">// from efs/filesystem.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">fs</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Filesystem</span>) <span style="color:#a6e22e">extents</span>(<span style="color:#a6e22e">in</span> <span style="color:#a6e22e">Inode</span>) []<span style="color:#a6e22e">Extent</span> {
	<span style="color:#a6e22e">payloadExtents</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">PayloadExtents</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">usesDirectExtents</span>() {
		<span style="color:#75715e">// if all of the extents fit inside of Payload (aka &#34;direct&#34;)
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// we have a much simpler time reading the extents
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">payloadExtents</span>
	}

	<span style="color:#75715e">// if we have more than will fit in Payload, then the extents
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// in Payload (aka &#34;indirect extents&#34;) point to ranges that
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// themselves contain the actual extents.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">extents</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">Extent</span>, <span style="color:#a6e22e">in</span>.<span style="color:#a6e22e">NumExtents</span>)
	<span style="color:#a6e22e">extentsFetched</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">indirectExtent</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">payloadExtents</span> {
		<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">extentBB</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">fs</span>.<span style="color:#a6e22e">ExtentToBlocks</span>(<span style="color:#a6e22e">indirectExtent</span>) {
			<span style="color:#75715e">// copy respecting the length of extents saves us from
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// accidentally including the garbage extents at the end
</span><span style="color:#75715e"></span>			<span style="color:#75715e">// of the last block (beyond NumExtents)
</span><span style="color:#75715e"></span>			copy(<span style="color:#a6e22e">extents</span>[<span style="color:#a6e22e">extentsFetched</span>:], <span style="color:#a6e22e">extentBB</span>.<span style="color:#a6e22e">ToExtents</span>())
			<span style="color:#a6e22e">extentsFetched</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">extentsPerBlock</span>
		}
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">extents</span>
}</code></pre></div>
<p>With this in place, I was able to get the contents of files, large and small! Mixed with the golang <code>archive/tar</code> library, I was able to get the tarball I had hoped for.</p>
<h2 id="harvesting-the-fruits-of-my-labor">Harvesting the fruits of my labor</h2>
<p>I copied the (hopefully correct) tarball to my NAS and unpacked it. Despite the 25 years between the birth of my Indy and my <a href="https://www.qnap.com/en-us/product/ts-231p">NAS</a> they both speak computing&rsquo;s lingua franca, unauthenticated NFS. The IRIX Software Manager doesn&rsquo;t care about <em>where</em> the software lives - it just wants a directory:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">ok so I got my last-weekend project of &quot;a tool that converts SGI EFS volumes in to tar files&quot;...working!?!?! and here I am pointing the install tool to an extracted tarball!?!?!?! <a href="https://t.co/IGXTTVbaet">pic.twitter.com/IGXTTVbaet</a></p>&mdash; cron mom (@sophaskins) <a href="https://twitter.com/sophaskins/status/1010630232360046593?ref_src=twsrc%5Etfw">June 23, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>The installation suceeded with no issues - I now have developer tools on my Indy! Entertainingly, one of the features this installed was kernel headers - including ones that describe (in more depth than the manpages) how EFS works.</p>
<h2 id="parting-thoughts">Parting thoughts</h2>
<p>I had an <em>enourmous</em> amount of fun completely over-engineering this problem. I was able to dig in to Unix filesystems for the first time in a practical context, had fun writing golang, and got some dev tools out of it to boot!</p>
<p>Have you ever written code to deal with raw filesystems? Or perhaps written software for IRIX? I&rsquo;d love to hear your stories! Send them to me via email: <a href="mailto:sophie@pizzabox.computer">sophie@pizzabox.computer</a>!</p>

</div>


    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-91739270-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    



  


<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.css" integrity="sha256-sCl5PUOGMLfFYctzDW3MtRib0ctyUvI9Qsmq2wXOeBY=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/default-skin/default-skin.min.css" integrity="sha256-BFeI1V+Vh1Rk37wswuOYn5lsTcaU96hGaI7OUVCLjPc=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe.min.js" integrity="sha256-UplRCs9v4KXVJvVY+p+RSo5Q4ilAUXh7kpjyIP5odyc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.1/photoswipe-ui-default.min.js" integrity="sha256-PWHOlUzc96pMc8ThwRIXPn8yH4NOLu42RQ0b9SpnpFk=" crossorigin="anonymous"></script>


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

    
    
  </body>
</html>
